<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Monika: AI-Powered Image Studio</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('ai-image-studio (9).jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #1f2937; /* Fallback color */
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Simple transition for smooth visibility changes */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Custom styles for aspect ratio buttons and new aspect ratios */
        .aspect-ratio-btn.active {
            background-color: #fff;
            color: #1f2937;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .dark .aspect-ratio-btn.active {
            background-color: #4b5563;
            color: #fff;
        }
        .aspect-9-16 {
             aspect-ratio: 9 / 16;
        }
        .aspect-3-4 {
             aspect-ratio: 3 / 4;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .image-preview-box {
            width: 100px;
            height: 100px;
            background-color: #e5e7eb;
            background-size: cover;
            background-position: center;
        }
        .dark .image-preview-box {
             background-color: #4b5563;
        }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto bg-white/50 dark:bg-gray-800/50 backdrop-blur-md rounded-2xl shadow-lg p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <div class="text-left">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white">Monika</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Your AI-Powered Image Studio</p>
            </div>
            <div class="flex items-center space-x-2">
                 <button id="change-app-bg-button" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">
                    <svg class="w-5 h-5 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01"></path></svg>
                </button>
                 <input type="file" id="app-bg-input" class="hidden" accept="image/*">
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5 text-gray-800 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
            </div>
        </div>

        <!-- Prompt Area -->
        <div class="mb-4">
            <label for="prompt-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">1. Generate an Image from Text</label>
            <textarea id="prompt-input" rows="3" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:text-white" placeholder="Describe the image you want to create..."></textarea>
            
            <!-- Aspect Ratio Selector -->
            <div class="my-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Aspect Ratio</label>
                <div id="aspect-ratio-selector" class="grid grid-cols-3 sm:grid-cols-5 gap-1 rounded-lg bg-gray-200 dark:bg-gray-700 p-1">
                    <button data-aspect="1:1" class="aspect-ratio-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md transition-colors">Square</button>
                    <button data-aspect="16:9" class="aspect-ratio-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md transition-colors">Landscape</button>
                    <button data-aspect="4:3" class="aspect-ratio-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md transition-colors">4:3</button>
                    <button data-aspect="9:16" class="aspect-ratio-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md transition-colors">Portrait</button>
                    <button data-aspect="3:4" class="aspect-ratio-btn flex-1 py-2 px-3 text-sm font-semibold rounded-md transition-colors">3:4</button>
                </div>
            </div>

            <div class="flex justify-between items-center mt-2 space-x-2">
                <button id="suggest-button" class="flex-1 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-sm font-semibold py-2 px-4 rounded-lg">✨ Suggest a Prompt</button>
                <button id="generate-button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Generate Image</button>
            </div>
        </div>

        <!-- Separator -->
        <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
            <span class="flex-shrink mx-4 text-gray-500 dark:text-gray-400 text-sm">OR</span>
            <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
        </div>

        <!-- Upload Area -->
        <div class="mb-4">
             <label for="upload-button" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">2. Upload Your Own Image</label>
            <input type="file" id="upload-input" class="hidden" accept="image/*">
            <button id="upload-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">📤 Upload an Image</button>
        </div>

        <div id="image-container" class="w-full bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center mb-6 overflow-hidden transition-all duration-300">
            <div id="placeholder-text" class="text-gray-500 dark:text-gray-400 text-center p-4">
                <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01"></path></svg>
                <p class="mt-2 font-semibold">Your image will appear here</p>
                <p class="text-sm">Enter a prompt or upload an image to start.</p>
            </div>
            <div id="loader" class="loader hidden"></div>
            <img id="generated-image" src="" alt="Generated Image" class="hidden w-full h-full object-cover">
        </div>

        <div id="status" class="text-center text-sm text-gray-500 dark:text-gray-400 min-h-[20px]">
        </div>
        
        <div id="error-container" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">Error:</strong>
            <span class="block sm:inline" id="error-message"></span>
        </div>

        <!-- Analysis & Edit Sections Container -->
        <div id="controls-container" class="hidden fade-in">
             <!-- Download Button -->
            <div class="text-center mb-6">
                 <button id="download-button" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download Image
                 </button>
            </div>

            <!-- Description Section -->
            <div id="description-section" class="mt-6">
                 <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-2 text-center">✨ Image Analysis & Interaction</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
                    <button id="describe-button" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg">🔬 Analyze Image</button>
                    <button id="read-aloud-button" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg inline-flex items-center justify-center" disabled>
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        Read Aloud
                    </button>
                </div>
                <div id="description-output" class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-sm text-gray-600 dark:text-gray-300 min-h-[50px]"></div>
                <div id="ask-question-section" class="mt-4">
                    <textarea id="question-input" rows="2" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:text-white" placeholder="Ask a specific question about the image..."></textarea>
                    <button id="ask-button" class="w-full mt-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg">❓ Ask Question</button>
                </div>
            </div>
    
            <!-- Edit Section -->
            <div id="edit-section" class="mt-6">
                 <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-2 text-center">Edit Image</h2>
                 <textarea id="edit-prompt-input" rows="3" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:text-white" placeholder="e.g., 'change her dress to blue' or 'make her wear a red jacket and sunglasses'"></textarea>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                    <button id="edit-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg">🎨 Apply Edit Manually</button>
                    <button id="extract-outfit-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg">👗 ✨ Smart Outfit Change</button>
                </div>
            </div>

            <!-- Change Background Section -->
            <div id="background-section" class="mt-6">
                 <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-2 text-center">Change Background</h2>
                 <textarea id="background-prompt-input" rows="3" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:text-white" placeholder="e.g., 'a futuristic cityscape with flying cars' or 'a serene beach at sunset'"></textarea>
                <div class="mt-2">
                    <button id="change-background-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg">🖼️ Change Background</button>
                </div>
            </div>
            
            <!-- Makeup & Hairstyle Transfer Section -->
            <div id="style-transfer-section" class="mt-6">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-2 text-center">💄 Makeup & Hairstyle Transfer</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Style Source -->
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Style Source</label>
                        <div id="style-source-preview" class="image-preview-box rounded-lg mx-auto mb-2 flex items-center justify-center text-gray-500 dark:text-gray-400">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </div>
                        <input type="file" id="style-source-input" class="hidden" accept="image/*">
                        <button id="style-source-upload-button" class="w-full text-sm bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold py-2 px-4 rounded-lg">Upload Style</button>
                    </div>
                    <!-- Target Image -->
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Target Image</label>
                         <div id="target-image-preview" class="image-preview-box rounded-lg mx-auto mb-2 flex items-center justify-center text-gray-500 dark:text-gray-400">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01"></path></svg>
                        </div>
                        <input type="file" id="target-image-input" class="hidden" accept="image/*">
                        <button id="target-image-upload-button" class="w-full text-sm bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold py-2 px-4 rounded-lg">Upload Target</button>
                    </div>
                </div>
                <div class="mt-4">
                    <button id="apply-style-button" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded-lg" disabled>Apply Makeup & Hairstyle</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const apiKey = ""; // Leave as-is; handled by the environment
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const suggestButton = document.getElementById('suggest-button');
        const uploadButton = document.getElementById('upload-button');
        const uploadInput = document.getElementById('upload-input');
        const imageElement = document.getElementById('generated-image');
        const placeholderText = document.getElementById('placeholder-text');
        const loader = document.getElementById('loader');
        const statusElement = document.getElementById('status');
        const controlsContainer = document.getElementById('controls-container');
        
        const errorContainer = document.getElementById('error-container');
        const errorMessageElement = document.getElementById('error-message');
        
        const describeButton = document.getElementById('describe-button');
        const descriptionOutput = document.getElementById('description-output');
        const readAloudButton = document.getElementById('read-aloud-button');
        const questionInput = document.getElementById('question-input');
        const askButton = document.getElementById('ask-button');

        const editPromptInput = document.getElementById('edit-prompt-input');
        const editButton = document.getElementById('edit-button');
        const extractOutfitButton = document.getElementById('extract-outfit-button');
        
        const backgroundPromptInput = document.getElementById('background-prompt-input');
        const changeBackgroundButton = document.getElementById('change-background-button');

        const aspectRatioSelector = document.getElementById('aspect-ratio-selector');
        const downloadButton = document.getElementById('download-button');

        // Style Transfer Elements
        const styleSourceInput = document.getElementById('style-source-input');
        const styleSourceUploadButton = document.getElementById('style-source-upload-button');
        const styleSourcePreview = document.getElementById('style-source-preview');
        const targetImageInput = document.getElementById('target-image-input');
        const targetImageUploadButton = document.getElementById('target-image-upload-button');
        const targetImagePreview = document.getElementById('target-image-preview');
        const applyStyleButton = document.getElementById('apply-style-button');
        
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        const changeAppBgButton = document.getElementById('change-app-bg-button');
        const appBgInput = document.getElementById('app-bg-input');

        let generatedImageData = null;
        let styleSourceImageData = null;
        let targetImageData = null;
        let currentAspectRatio = '1:1';
        
        // --- THEME SETUP ---
        const applyTheme = () => {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                if(themeToggleDarkIcon) themeToggleDarkIcon.classList.add('hidden');
                if(themeToggleLightIcon) themeToggleLightIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                if(themeToggleDarkIcon) themeToggleDarkIcon.classList.remove('hidden');
                if(themeToggleLightIcon) themeToggleLightIcon.classList.add('hidden');
            }
        };
        applyTheme();

        // --- BACKGROUND SETUP ---
        const applyBackground = () => {
            const savedBg = localStorage.getItem('appBackgroundImage');
            if (savedBg) {
                document.body.style.backgroundImage = `url('${savedBg}')`;
            }
        };
        applyBackground();


        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('image-container').classList.add('aspect-square');

            generateButton.addEventListener('click', generateImage);
            suggestButton.addEventListener('click', suggestPrompt);
            describeButton.addEventListener('click', describeImage);
            readAloudButton.addEventListener('click', readAloud);
            askButton.addEventListener('click', askQuestion);
            
            aspectRatioSelector.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentAspectRatio = e.target.dataset.aspect;
                    updateAspectRatioButtons();
                }
            });
            updateAspectRatioButtons();

            downloadButton.addEventListener('click', downloadImage);
            
            editButton.addEventListener('click', () => {
                const editPrompt = editPromptInput.value;
                if (editPrompt) {
                    editImage(editPrompt);
                } else {
                    showTemporaryStatus('Please enter an edit description.');
                }
            });
            
            extractOutfitButton.addEventListener('click', extractAndApplyOutfitChange);
            uploadButton.addEventListener('click', () => uploadInput.click());
            uploadInput.addEventListener('change', handleImageUpload);
        
            changeBackgroundButton.addEventListener('click', changeBackground);

            // Style Transfer Listeners
            styleSourceUploadButton.addEventListener('click', () => styleSourceInput.click());
            styleSourceInput.addEventListener('change', handleStyleSourceUpload);
            targetImageUploadButton.addEventListener('click', () => targetImageInput.click());
            targetImageInput.addEventListener('change', handleTargetImageUpload);
            applyStyleButton.addEventListener('click', applyMakeupAndHairstyle);

            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
                applyTheme();
            });

            changeAppBgButton.addEventListener('click', () => appBgInput.click());
            appBgInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    document.body.style.backgroundImage = `url('${imageUrl}')`;
                    try {
                        localStorage.setItem('appBackgroundImage', imageUrl);
                    } catch (error) {
                        console.error("Could not save background to local storage:", error);
                        showTemporaryStatus("Couldn't save new background permanently.");
                    }
                };
                reader.readAsDataURL(file);
            });
        });
        
        function checkCanApplyStyle() {
            if(styleSourceImageData && targetImageData) {
                applyStyleButton.disabled = false;
            } else {
                applyStyleButton.disabled = true;
            }
        }

        function handleStyleSourceUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                styleSourceImageData = e.target.result.split(',')[1];
                styleSourcePreview.style.backgroundImage = `url('${e.target.result}')`;
                styleSourcePreview.innerHTML = ''; // Clear icon
                checkCanApplyStyle();
            };
            reader.readAsDataURL(file);
        }
        
        function handleTargetImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                targetImageData = e.target.result.split(',')[1];
                targetImagePreview.style.backgroundImage = `url('${e.target.result}')`;
                targetImagePreview.innerHTML = ''; // Clear icon
                checkCanApplyStyle();
            };
            reader.readAsDataURL(file);
        }

        function updateAspectRatioButtons() {
            const buttons = aspectRatioSelector.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.dataset.aspect === currentAspectRatio) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
        
        function showTemporaryStatus(message, duration = 3000) {
            statusElement.textContent = message;
            setTimeout(() => {
                if (statusElement.textContent === message) {
                    statusElement.textContent = '';
                }
            }, duration);
        }

        async function fetchWithExponentialBackoff(url, options, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithExponentialBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }
        
        function getGenerateContentError(result) {
            // Check for a specific block reason
            if (result && result.promptFeedback && result.promptFeedback.blockReason) {
                return `Request was blocked due to: ${result.promptFeedback.blockReason}. Please modify your prompt.`;
            }
            // Check for other errors in the response
            if (result && result.error && result.error.message) {
                return `API Error: ${result.error.message}`;
            }
            // Generic error if no specific information is found
            return 'The model could not generate the content. Please try a different prompt.';
        }


        function downloadImage() {
            if (!generatedImageData) {
                showTemporaryStatus('No image to download.');
                return;
            }
            const link = document.createElement('a');
            link.href = `data:image/png;base64,${generatedImageData}`;
            link.download = `ai-studio-image-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function resetAnalysisState() {
            descriptionOutput.textContent = '';
            questionInput.value = '';
            readAloudButton.disabled = true;
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                generatedImageData = e.target.result.split(',')[1];
                imageElement.src = e.target.result;
                
                placeholderText.classList.add('hidden');
                loader.classList.add('hidden');
                imageElement.classList.remove('hidden');
                controlsContainer.classList.remove('hidden');
                statusElement.textContent = 'Image uploaded successfully.';
                resetAnalysisState();
                editPromptInput.value = '';
            };
            reader.readAsDataURL(file);
            event.target.value = null;
        }


        async function applyMakeupAndHairstyle() {
            if (!styleSourceImageData || !targetImageData) {
                showTemporaryStatus('Please upload both a style source and a target image.');
                return;
            }

            placeholderText.classList.add('hidden');
            loader.classList.remove('hidden');
            imageElement.classList.add('hidden');
            statusElement.textContent = 'Applying new style... This may take a moment.';
            errorContainer.classList.add('hidden');
            applyStyleButton.disabled = true;
            applyStyleButton.textContent = 'Applying...';
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: "Apply the makeup and hairstyle from the first image (style source) to the person in the second image (target). Keep the target person's identity and facial features intact, only changing their makeup and hair." },
                        { inlineData: { mimeType: "image/png", data: styleSourceImageData } },
                        { inlineData: { mimeType: "image/png", data: targetImageData } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const newImageData = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (newImageData) {
                    generatedImageData = newImageData; // Update main image
                    imageElement.src = `data:image/png;base64,${generatedImageData}`;
                    loader.classList.add('hidden');
                    imageElement.classList.remove('hidden');
                    statusElement.textContent = 'Makeup & Hairstyle applied successfully!';
                    controlsContainer.classList.remove('hidden'); // Ensure controls are visible for the new image
                    resetAnalysisState();
                } else {
                    throw new Error(getGenerateContentError(result));
                }
            } catch (error) {
                console.error('Style transfer failed:', error);
                loader.classList.add('hidden');
                placeholderText.classList.remove('hidden');
                errorMessageElement.textContent = `Failed to apply style. ${error.message}`;
                errorContainer.classList.remove('hidden');
                statusElement.textContent = 'Style transfer failed.';
            } finally {
                applyStyleButton.disabled = false;
                applyStyleButton.textContent = 'Apply Makeup & Hairstyle';
            }
        }


        async function changeBackground() {
            const backgroundPrompt = backgroundPromptInput.value;
            if (!backgroundPrompt) {
                showTemporaryStatus('Please enter a description for the new background.');
                return;
            }
            if (!generatedImageData) {
                showTemporaryStatus('Please generate or upload an image first.');
                return;
            }

            placeholderText.classList.add('hidden');
            loader.classList.remove('hidden');
            imageElement.classList.add('hidden');
            statusElement.textContent = 'Changing background... This may take a moment.';
            errorContainer.classList.add('hidden');
            changeBackgroundButton.disabled = true;
            changeBackgroundButton.textContent = 'Applying...';

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: `Change the background of this image to: "${backgroundPrompt}". IMPORTANT: Keep the foreground subject (the person, throne, and sword) exactly the same, without any changes.` },
                        { inlineData: { mimeType: "image/png", data: generatedImageData } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const newImageData = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (newImageData) {
                    generatedImageData = newImageData;
                    imageElement.src = `data:image/png;base64,${generatedImageData}`;
                    loader.classList.add('hidden');
                    imageElement.classList.remove('hidden');
                    statusElement.textContent = 'Background changed successfully!';
                    resetAnalysisState();
                    backgroundPromptInput.value = ''; 
                } else {
                    throw new Error(getGenerateContentError(result));
                }
            } catch (error) {
                console.error('Background change failed:', error);
                loader.classList.add('hidden');
                imageElement.classList.remove('hidden'); // Show original image on failure
                errorMessageElement.textContent = `Failed to change background. ${error.message}`;
                errorContainer.classList.remove('hidden');
                statusElement.textContent = 'Background change failed.';
            } finally {
                changeBackgroundButton.disabled = false;
                changeBackgroundButton.textContent = '🖼️ Change Background';
            }
        }


        async function generateImage() {
            const prompt = promptInput.value;
            if (!prompt) {
                showTemporaryStatus('Please enter a prompt to generate an image.');
                return;
            }

            const imageContainer = document.getElementById('image-container');
            imageContainer.classList.remove('aspect-square', 'aspect-video', 'aspect-9-16', 'aspect-[4/3]', 'aspect-3-4');
            if (currentAspectRatio === '1:1') imageContainer.classList.add('aspect-square');
            else if (currentAspectRatio === '16:9') imageContainer.classList.add('aspect-video');
            else if (currentAspectRatio === '4:3') imageContainer.classList.add('aspect-[4/3]');
            else if (currentAspectRatio === '9:16') imageContainer.classList.add('aspect-9-16');
            else if (currentAspectRatio === '3:4') imageContainer.classList.add('aspect-3-4');


            placeholderText.classList.add('hidden');
            loader.classList.remove('hidden');
            imageElement.classList.add('hidden');
            statusElement.textContent = 'Generating image... This may take a moment.';
            controlsContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            generateButton.disabled = true;
            generateButton.textContent = 'Generating...';

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const payload = { 
                instances: [{ "prompt": `${prompt}, aspect_ratio: ${currentAspectRatio}` }],
                parameters: { "sampleCount": 1 }
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    generatedImageData = result.predictions[0].bytesBase64Encoded;
                    imageElement.src = `data:image/png;base64,${generatedImageData}`;
                    loader.classList.add('hidden');
                    imageElement.classList.remove('hidden');
                    statusElement.textContent = 'Image generated successfully!';
                    controlsContainer.classList.remove('hidden');
                    resetAnalysisState();
                } else {
                    throw new Error(result.error ? result.error.message : 'No image data returned from API.');
                }
            } catch (error) {
                console.error('Image generation failed:', error);
                loader.classList.add('hidden');
                placeholderText.classList.remove('hidden'); // Show placeholder on failure
                errorMessageElement.textContent = `Image generation failed. ${error.message}`;
                errorContainer.classList.remove('hidden');
                statusElement.textContent = 'Image generation failed.';
            } finally {
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Image';
            }
        }

        async function suggestPrompt() {
            statusElement.textContent = 'Getting a suggestion...';
            suggestButton.disabled = true;
            suggestButton.textContent = '...';

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: "Suggest a short, creative, and visually interesting prompt for an AI image generator. The prompt should be a single sentence and not a question." }] }],
                 systemInstruction: {
                    parts: [{ text: "You are a creative assistant that provides prompts for an AI image generator." }]
                },
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const suggestion = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (suggestion) {
                    promptInput.value = suggestion.trim().replace(/^"|"$/g, ''); // Remove quotes
                    statusElement.textContent = 'New prompt suggested!';
                } else {
                     throw new Error('Could not retrieve a suggestion.');
                }
            } catch (error) {
                console.error('Prompt suggestion failed:', error);
                statusElement.textContent = 'Failed to get a suggestion.';
            } finally {
                suggestButton.disabled = false;
                suggestButton.textContent = '✨ Suggest a Prompt';
            }
        }
        
        async function askQuestion() {
            const question = questionInput.value;
            if (!question) {
                showTemporaryStatus('Please enter a question to ask about the image.');
                return;
            }
             if (!generatedImageData) {
                showTemporaryStatus('Please generate or upload an image first.');
                return;
            }

            descriptionOutput.textContent = 'Thinking...';
            askButton.disabled = true;
            askButton.textContent = 'Asking...';
            readAloudButton.disabled = true;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: question },
                            { inlineData: { mimeType: "image/png", data: generatedImageData } }
                        ]
                    }
                ],
            };
             try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const answer = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (answer) {
                    descriptionOutput.textContent = answer;
                    readAloudButton.disabled = false;
                } else {
                    throw new Error(getGenerateContentError(result));
                }
            } catch (error) {
                console.error('Asking question failed:', error);
                descriptionOutput.textContent = `Failed to get an answer. ${error.message}`;
            } finally {
                askButton.disabled = false;
                askButton.textContent = '❓ Ask Question';
                questionInput.value = '';
            }
        }


        async function describeImage() {
            if (!generatedImageData) {
                showTemporaryStatus('Please generate or upload an image first to describe it.');
                return;
            }

            descriptionOutput.textContent = 'Analyzing...';
            describeButton.disabled = true;
            describeButton.textContent = 'Analyzing...';
            readAloudButton.disabled = true;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: "Provide a concise description of this image, focusing on the main subject, their clothing, and the setting." },
                            { inlineData: { mimeType: "image/png", data: generatedImageData } }
                        ]
                    }
                ],
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const description = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (description) {
                    descriptionOutput.textContent = description;
                    readAloudButton.disabled = false;
                } else {
                    throw new Error(getGenerateContentError(result));
                }
            } catch (error) {
                console.error('Image description failed:', error);
                descriptionOutput.textContent = `Failed to analyze the image. ${error.message}`;
            } finally {
                describeButton.disabled = false;
                describeButton.textContent = '🔬 Analyze Image';
            }
        }

        async function readAloud() {
            const textToSpeak = descriptionOutput.textContent;
            if (!textToSpeak || textToSpeak === 'Analyzing...' || textToSpeak === 'Thinking...') {
                showTemporaryStatus('Nothing to read yet. Analyze the image first.');
                return;
            }

            readAloudButton.disabled = true;
            const originalButtonContent = readAloudButton.innerHTML;
            readAloudButton.innerHTML = `<svg class="w-5 h-5 mr-2 animate-pulse" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zM4 9a1 1 0 011 1v4a1 1 0 11-2 0v-4a1 1 0 011-1zM16 9a1 1 0 011 1v4a1 1 0 11-2 0v-4a1 1 0 011-1z"></path></svg> Reading...`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => {
                         readAloudButton.disabled = false;
                         readAloudButton.innerHTML = originalButtonContent;
                    };
                } else {
                     throw new Error('No audio data received from API.');
                }

            } catch(error) {
                 console.error('Text-to-speech failed:', error);
                 statusElement.textContent = `Failed to read aloud. ${error.message}`;
                 readAloudButton.disabled = false;
                 readAloudButton.innerHTML = originalButtonContent;
            }
        }
        
        async function extractAndApplyOutfitChange() {
            if (!generatedImageData) {
                showTemporaryStatus('Please generate or upload an image first.');
                return;
            }
            
            const originalStatusText = statusElement.textContent;
            statusElement.textContent = 'Analyzing outfit for editing...';
            extractOutfitButton.disabled = true;
            extractOutfitButton.textContent = 'Analyzing...';
            
            // First, get a description of the outfit
            const describeApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const describePayload = {
                contents: [{
                    parts: [
                        { text: "Based on the image, what is a simple, creative, and different outfit the person could wear? For example, if they are wearing a t-shirt, suggest a leather jacket. Provide only the name of the new outfit, like 'a black leather jacket and sunglasses'." },
                        { inlineData: { mimeType: "image/png", data: generatedImageData } }
                    ]
                }],
            };

            try {
                const describeResponse = await fetchWithExponentialBackoff(describeApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(describePayload)
                });
                const describeResult = await describeResponse.json();
                const outfitSuggestion = describeResult.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!outfitSuggestion) {
                    throw new Error('Could not get an outfit suggestion.');
                }
                
                // Now, call the edit function with the new outfit
                statusElement.textContent = `Changing outfit to: ${outfitSuggestion.trim()}`;
                await editImage(`make the person wear ${outfitSuggestion.trim()}`);
                
            } catch (error) {
                console.error('Smart outfit change failed:', error);
                errorMessageElement.textContent = `Smart outfit change failed: ${error.message}`;
                errorContainer.classList.remove('hidden');
                statusElement.textContent = originalStatusText; // Restore original status
            } finally {
                extractOutfitButton.disabled = false;
                extractOutfitButton.textContent = '👗 ✨ Smart Outfit Change';
            }
        }


        async function editImage(editPrompt) {
            if (!generatedImageData) {
                showTemporaryStatus('Please generate or upload an image first to edit it.');
                return;
            }
            if (!editPrompt) {
                showTemporaryStatus('Please provide instructions on how to edit the image.');
                return;
            }
            
            placeholderText.classList.add('hidden');
            loader.classList.remove('hidden');
            imageElement.classList.add('hidden');
            statusElement.textContent = 'Applying edits... This may take a moment.';
            errorContainer.classList.add('hidden');
            editButton.disabled = true;
            editButton.textContent = 'Applying...';
            extractOutfitButton.disabled = true;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: editPrompt },
                        { inlineData: { mimeType: "image/png", data: generatedImageData } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const newImageData = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (newImageData) {
                    generatedImageData = newImageData;
                    imageElement.src = `data:image/png;base64,${generatedImageData}`;
                    loader.classList.add('hidden');
                    imageElement.classList.remove('hidden');
                    statusElement.textContent = 'Image edited successfully!';
                    resetAnalysisState();
                    editPromptInput.value = ''; // Clear the prompt
                } else {
                     throw new Error(getGenerateContentError(result));
                }
            } catch (error) {
                console.error('Image edit failed:', error);
                loader.classList.add('hidden');
                imageElement.classList.remove('hidden'); // Show original image on failure
                errorMessageElement.textContent = `Image edit failed. ${error.message}`;
                errorContainer.classList.remove('hidden');
                statusElement.textContent = 'Image edit failed.';
            } finally {
                editButton.disabled = false;
                editButton.textContent = '🎨 Apply Edit Manually';
                extractOutfitButton.disabled = false;
            }
        }
        
        // --- AUDIO HELPER FUNCTIONS ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * bitsPerSample / 8;
            const blockAlign = numChannels * bitsPerSample / 8;
            const dataSize = pcmData.byteLength;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            const pcmAsUint8 = new Uint8Array(pcmData.buffer);
            for (let i = 0; i < dataSize; i++) {
                view.setUint8(44 + i, pcmAsUint8[i]);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

    </script>
</body>
</html>

